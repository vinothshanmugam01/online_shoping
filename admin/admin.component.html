<!-- Admin Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">INFINITE MART</a>
    <div class="ms-auto">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" (click)="handleLogout()" style="cursor: pointer;">
            <i class="bi bi-box-arrow-right"></i> Logout
          </a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<main class="container mt-5 mb-5">
  <div class="mb-4">
    <button class="btn btn-info me-2" routerLink="/admin-orders">View Orders</button>
    <button class="btn btn-info" routerLink="/admin-feedbacks">Check Feedback</button>
  </div>
  <h2>Admin Dashboard - Manage Products</h2>

  <!-- Statistical Cards -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card text-white bg-primary">
        <div class="card-body">
          <h5 class="card-title">Total Sales</h5>
          <p class="card-text">{{ totalSales | currency:'INR' }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-white bg-success">
        <div class="card-body">
          <h5 class="card-title">Total Orders</h5>
          <p class="card-text">{{ totalOrders }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-white bg-info">
        <div class="card-body">
          <h5 class="card-title">Total Feedbacks</h5>
          <p class="card-text">{{ totalFeedbacks }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Message -->
  <div *ngIf="errorMessage" class="alert alert-danger mt-3">
    {{ errorMessage }}
  </div>

  <!-- Charts -->
  <div class="row mb-4">
    <!-- Bar Chart -->
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">Orders per Month</div>
        <div class="card-body">
          <canvas baseChart
                  [datasets]="barChartDatasets"
                  [labels]="barChartLabels"
                  [options]="barChartOptions"
                  [type]="barChartType">
          </canvas>
        </div>
      </div>
    </div>
    <!-- Pie Chart -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">Product Category Distribution</div>
        <div class="card-body">
          <canvas baseChart
                  [datasets]="pieChartDatasets"
                  [labels]="pieChartLabels"
                  [options]="pieChartOptions"
                  [type]="pieChartType">
          </canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Product Form -->
  <div class="card mb-4">
    <div class="card-header">Add New Product</div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="pdId" class="form-label">Product ID</label>
          <input type="number" class="form-control" id="pdId" [(ngModel)]="newProduct.pdId" required>
        </div>
        <div class="col-md-6 mb-3">
          <label for="pdName" class="form-label">Product Name</label>
          <input type="text" class="form-control" id="pdName" [(ngModel)]="newProduct.pdName" required>
        </div>
        <div class="col-md-6 mb-3">
          <label for="pdDesc" class="form-label">Description</label>
          <textarea class="form-control" id="pdDesc" [(ngModel)]="newProduct.pdDesc" required></textarea>
        </div>
        <div class="col-md-6 mb-3">
          <label for="pdPrice" class="form-label">Price</label>
          <input type="number" class="form-control" id="pdPrice" [(ngModel)]="newProduct.pdPrice" required>
        </div>
        <div class="col-md-6 mb-3">
          <label for="pdCategory" class="form-label">Category</label>
          <select class="form-control" id="pdCategory" [(ngModel)]="newProduct.pdCategory" required (change)="updateSubCategories()">
            <option value="" disabled>Select Category</option>
            <option *ngFor="let category of categoriesData" [value]="category.code">{{category.name}}</option>
          </select>
        </div>
        <div class="col-md-6 mb-3">
          <label for="pdSubCategory" class="form-label">Subcategory</label>
          <select class="form-control" id="pdSubCategory" [(ngModel)]="newProduct.pdSubCategory" required>
            <option value="" disabled>Select Subcategory</option>
            <option *ngFor="let subCategory of subCategories" [value]="subCategory">{{subCategory}}</option>
          </select>
        </div>
        <div class="col-md-6 mb-3">
          <label for="pdImg" class="form-label">Product Image</label>
          <input type="file" class="form-control" id="pdImg" (change)="onFileChange($event, 'new')">
        </div>
        <div class="col-12">
          <button class="btn btn-primary" (click)="addProduct()" [disabled]="!newProduct.pdId || !newProduct.pdName || !newProduct.pdDesc || !newProduct.pdPrice || !newProduct.pdCategory || !newProduct.pdSubCategory">Add Product</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Product Form -->
  <div class="card mb-4" *ngIf="editingProduct">
    <div class="card-header">Edit Product</div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="editPdId" class="form-label">Product ID</label>
          <input type="number" class="form-control" id="editPdId" [(ngModel)]="editingProduct.pdId" disabled>
        </div>
        <div class="col-md-6 mb-3">
          <label for="editPdName" class="form-label">Product Name</label>
          <input type="text" class="form-control" id="editPdName" [(ngModel)]="editingProduct.pdName" required>
        </div>
        <div class="col-md-6 mb-3">
          <label for="editPdDesc" class="form-label">Description</label>
          <textarea class="form-control" id="editPdDesc" [(ngModel)]="editingProduct.pdDesc" required></textarea>
        </div>
        <div class="col-md-6 mb-3">
          <label for="editPdPrice" class="form-label">Price</label>
          <input type="number" class="form-control" id="editPdPrice" [(ngModel)]="editingProduct.pdPrice" required>
        </div>
        <div class="col-md-6 mb-3">
          <label for="editPdCategory" class="form-label">Category</label>
          <select class="form-control" id="editPdCategory" [(ngModel)]="editingProduct.pdCategory" required (change)="updateSubCategories(true)">
            <option value="" disabled>Select Category</option>
            <option *ngFor="let category of categoriesData" [value]="category.code">{{category.name}}</option>
          </select>
        </div>
        <div class="col-md-6 mb-3">
          <label for="editPdSubCategory" class="form-label">Subcategory</label>
          <select class="form-control" id="editPdSubCategory" [(ngModel)]="editingProduct.pdSubCategory" required>
            <option value="" disabled>Select Subcategory</option>
            <option *ngFor="let subCategory of subCategories" [value]="subCategory">{{subCategory}}</option>
          </select>
        </div>
        <div class="col-md-6 mb-3">
          <label for="editPdImg" class="form-label">Product Image</label>
          <input type="file" class="form-control" id="editPdImg" (change)="onFileChange($event, 'edit')">
        </div>
        <div class="col-12">
          <button class="btn btn-success" (click)="updateProduct()" [disabled]="!editingProduct.pdName || !editingProduct.pdDesc || !editingProduct.pdPrice || !editingProduct.pdCategory || !editingProduct.pdSubCategory">Update Product</button>
          <button class="btn btn-secondary ms-2" (click)="editingProduct = null">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Product List -->
  <div class="table-responsive">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Description</th>
          <th>Price</th>
          <th>Category</th>
          <th>Subcategory</th>
          <th>Image</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let product of products">
          <td>{{product.pdId}}</td>
          <td>{{product.pdName}}</td>
          <td>{{product.pdDesc}}</td>
          <td>{{product.pdPrice | currency:'INR'}}</td>
          <td>{{getCategoryName(product.pdCategory)}}</td>
          <td>{{product.pdSubCategory}}</td>
          <td>
            <img [src]="getImageUrl(product.pdImg)" alt="{{product.pdName}}" style="width: 50px;">
          </td>
          <td>
            <button class="btn btn-sm btn-warning me-2" (click)="editProduct(product)">Edit</button>
            <button class="btn btn-sm btn-danger" (click)="deleteProduct(product._id)">Delete</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</main>